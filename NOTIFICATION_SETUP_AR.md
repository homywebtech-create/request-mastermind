# إعداد الإشعارات الصوتية - دليل كامل

## المشكلة المحلولة
تم إصلاح مشاكل:
- ✅ عدم وجود صوت عند استلام طلب جديد
- ✅ عدم ظهور التطبيق في الواجهة عند استلام إشعار
- ✅ عدم عمل الإشعارات عندما يكون التطبيق مغلقًا
- ✅ تسجيل الخروج التلقائي من التطبيق

## التحديثات المطبقة (النسخة 2.2)

### 1. نظام الإشعارات المحسّن
- إشعارات ذات أولوية قصوى (High Priority Heads-Up Notifications)
- صوت مخصص طويل مثل تطبيقات أوبر وواتساب
- إضاءة LED حمراء
- اهتزاز قوي
- ظهور الإشعار حتى عندما يكون التطبيق مغلقًا تمامًا

### 2. إصلاح تسجيل الخروج التلقائي
- حفظ الجلسة بشكل دائم في Capacitor Preferences
- استرجاع الجلسة تلقائيًا عند فتح التطبيق
- عدم حذف الجلسة إلا عند الضغط على تسجيل الخروج

## خطوات التطبيق

### الخطوة 1: تحديث الكود
```bash
git pull
npm run build
npx cap sync
```

### الخطوة 2: إضافة ملف الصوت المخصص (مهم جداً!)

#### للأندرويد:
1. قم بتحميل أو تسجيل ملف صوت MP3 طويل (15-30 ثانية)
   - يفضل استخدام ringtone مشابه لأصوات المكالمات
   - أو استخدام أصوات تطبيقات الأذان (صوت قوي ومستمر)

2. انسخ الملف إلى:
   ```
   android/app/src/main/res/raw/notification_sound.mp3
   ```

3. إذا لم يكن المجلد `raw` موجوداً، قم بإنشائه:
   ```bash
   mkdir -p android/app/src/main/res/raw
   ```

4. تأكد من أن اسم الملف هو `notification_sound.mp3` بالضبط

#### للـ iOS:
1. انسخ الملف إلى:
   ```
   ios/App/App/sounds/notification_sound.mp3
   ```

### الخطوة 3: تشغيل التطبيق
```bash
npx cap run android
# أو
npx cap run ios
```

## كيفية الحصول على أصوات مناسبة

### خيار 1: تحميل من مواقع الأصوات المجانية
- Zedge: https://www.zedge.net/ringtones
- Notification Sounds: https://notificationsounds.com/
- ابحث عن: "long alarm ringtone" أو "phone call ringtone"

### خيار 2: استخراج من تطبيقات أخرى
- استخدم تطبيق مثل Zarchiver لاستخراج ملفات APK
- ابحث في مجلد res/raw عن ملفات الصوت

### خيار 3: تسجيل صوت مخصص
- استخدم تطبيق تسجيل صوتي
- قم بتسجيل أو تحرير صوت بطول 15-30 ثانية
- احفظه بصيغة MP3

## المواصفات الموصى بها للصوت

```
النوع: MP3
المدة: 15-30 ثانية
Bitrate: 128 kbps
Sample Rate: 44100 Hz
حجم الملف: أقل من 2 MB
الصوت: عالي وواضح (لكي يوقظ المستخدم)
```

## اختبار الإشعارات

### 1. اختبار مع التطبيق مفتوح:
- افتح التطبيق
- اطلب من شخص آخر إنشاء طلب جديد
- يجب أن تسمع الصوت وترى إشعاراً في الأعلى

### 2. اختبار مع التطبيق في الخلفية:
- اضغط على زر Home (لا تقفل التطبيق)
- اطلب من شخص آخر إنشاء طلب جديد
- يجب أن تسمع الصوت وترى إشعار Heads-Up

### 3. اختبار مع التطبيق مغلق تماماً:
- أغلق التطبيق من Recent Apps (اسحب وأغلق)
- اطلب من شخص آخر إنشاء طلب جديد
- يجب أن تسمع الصوت وترى إشعاراً

## استكشاف الأخطاء

### المشكلة: لا يوجد صوت
**الحل:**
1. تأكد من وجود ملف `notification_sound.mp3` في المسار الصحيح
2. تأكد من أن صوت الإشعارات ليس على Mute في الهاتف
3. تأكد من تشغيل وضع الصوت (وليس Silent Mode)
4. قم بتشغيل `npx cap sync` مرة أخرى

### المشكلة: الإشعار لا يظهر
**الحل:**
1. تأكد من منح أذونات الإشعارات للتطبيق
2. في إعدادات الأندرويد > التطبيقات > Request Mastermind > الإشعارات
3. تأكد من تفعيل "New Job Offers - High Priority"
4. اضبط الأولوية على "عاجل" أو "High"

### المشكلة: التطبيق لا يفتح عند الضغط على الإشعار
**الحل:**
- التطبيق يفتح تلقائياً، لكن قد يكون في الخلفية
- اسحب شريط الإشعارات واضغط على الإشعار مباشرة

### المشكلة: الإشعارات لا تعمل عندما يكون التطبيق مغلقاً تماماً
**الحل:**
- في بعض هواتف الأندرويد (خاصة Xiaomi, Huawei, Oppo):
  1. اذهب إلى إعدادات البطارية
  2. أوقف "Battery Optimization" للتطبيق
  3. اسمح بـ "Autostart" للتطبيق
  4. أوقف "Battery Saver" إذا كان مفعلاً

## التحقق من نجاح التحديث

عند فتح التطبيق، يجب أن ترى رسالة:
```
✅ التطبيق محدث - النسخة 2.2 (إشعارات محسنة)
```

إذا لم تظهر هذه الرسالة، قم بإعادة التطبيق للخطوات أعلاه.

## ملاحظات مهمة

1. **أذونات الأندرويد:**
   - يحتاج التطبيق إلى أذونات الإشعارات
   - سيطلبها تلقائياً عند أول فتح

2. **قيود الأندرويد:**
   - بعض الهواتف (Xiaomi, Oppo, etc.) لديها قيود على الإشعارات في الخلفية
   - قد تحتاج إلى ضبط إعدادات التطبيق يدوياً

3. **حجم ملف الصوت:**
   - استخدم ملفات صغيرة (أقل من 2MB)
   - الملفات الكبيرة قد تسبب بطء في الإشعارات

4. **التحديثات المستقبلية:**
   - بعد أي `git pull` جديد، قم بتشغيل `npx cap sync`
   - لا تنسَ نسخ ملف الصوت مرة أخرى إذا حذف

## الدعم

إذا استمرت المشاكل:
1. تحقق من console logs: `adb logcat | grep Capacitor`
2. تأكد من أن Capacitor محدث: `npm i @capacitor/local-notifications@latest`
3. أعد بناء التطبيق من الصفر: `rm -rf android/app/build && npx cap sync`
