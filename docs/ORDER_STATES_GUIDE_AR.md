# Ø¯Ù„ÙŠÙ„ Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø·Ù„Ø¨Ø§Øª - Ù†Ø¸Ø§Ù… Ø´Ø§Ù…Ù„

## ğŸ”„ Ø¯ÙˆØ±Ø© Ø­ÙŠØ§Ø© Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„ÙƒØ§Ù…Ù„Ø©

### Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø£ÙˆÙ„: Ø§Ù„Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ âœ…
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. pending        â†’ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ (Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù…Ø­ØªØ±Ù)          â”‚
â”‚  2. in-progress    â†’ Ù…Ø­ØªØ±Ù Ø¨Ø¯Ø£ Ø¨Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø·Ù„Ø¨         â”‚
â”‚  3. upcoming       â†’ ØªÙ… ØªØ£ÙƒÙŠØ¯ Ù…ÙˆØ¹Ø¯ Ù…Ø¹ Ø§Ù„Ø¹Ù…ÙŠÙ„            â”‚
â”‚  4. confirmed      â†’ ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ ÙˆÙ…Ø­ØªØ±Ù Ù…Ø¹ÙŠÙ†          â”‚
â”‚                                                          â”‚
â”‚  ===== Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªØªØ¨Ø¹ (Tracking) =====                    â”‚
â”‚  5. moving         â†’ Ø§Ù„Ù…Ø­ØªØ±Ù ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚ Ù„Ù„Ø¹Ù…ÙŠÙ„          â”‚
â”‚  6. arrived        â†’ Ø§Ù„Ù…Ø­ØªØ±Ù ÙˆØµÙ„ Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…ÙŠÙ„           â”‚
â”‚  7. waiting        â†’ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ù„Ù‡ ÙˆÙ‚Øª Ù…Ø­Ø¯Ø¯)       â”‚
â”‚  8. working        â†’ Ø¨Ø¯Ø£ Ø§Ù„Ø¹Ù…Ù„                          â”‚
â”‚  9. invoice_requested â†’ Ø·Ù„Ø¨ Ø§Ù„ÙØ§ØªÙˆØ±Ø©                   â”‚
â”‚  10. payment_received â†’ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¯ÙØ¹                   â”‚
â”‚                                                          â”‚
â”‚  11. completed     â†’ Ø§ÙƒØªÙ…Ù„ Ø§Ù„Ø·Ù„Ø¨ âœ…                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ: Ø§Ù„Ø¥Ù„ØºØ§Ø¡ âŒ
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¥Ù„ØºØ§Ø¡ Ù…Ù† Ø£ÙŠ Ù…Ø±Ø­Ù„Ø©                   â”‚
â”‚  â†“                                           â”‚
â”‚  status: 'cancelled'                        â”‚
â”‚  tracking_stage: null (ÙŠØ¬Ø¨ ØªØµÙÙŠØ±Ù‡!)        â”‚
â”‚  cancelled_at: timestamp                    â”‚
â”‚  cancelled_by: user_id                      â”‚
â”‚  cancellation_reason: text                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø«Ø§Ù„Ø«: Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¹Ø§Ù„Ù‚Ø© ğŸ”„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Ø·Ù„Ø¨ ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± (waiting)                  â”‚
â”‚  â†“                                                â”‚
â”‚  Ø¥Ø°Ø§ Ø§Ù†ØªÙ‡Ù‰ ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± (waiting_ends_at)        â”‚
â”‚  â†“                                                â”‚
â”‚  ÙŠØªÙ… Ù†Ù‚Ù„Ù‡ Ø¥Ù„Ù‰ pending (Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©)                 â”‚
â”‚  Ø£Ùˆ cancelled (Ø­Ø³Ø¨ Ø§Ù„Ø³ÙŠØ§Ø³Ø©)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âš ï¸ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…ØªÙ†Ø§Ù‚Ø¶Ø© (Inconsistent States)

### 1. ğŸ”´ Ø·Ù„Ø¨ Ù…Ù„ØºÙŠ Ù„ÙƒÙ† Ù„Ù‡ tracking_stage
**Ø§Ù„Ù…Ø´ÙƒÙ„Ø©:**
```json
{
  "status": "cancelled",
  "tracking_stage": "working",  // âŒ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† null
  "cancelled_at": "2025-11-13T08:10:16.461Z"
}
```

**Ø§Ù„Ø³Ø¨Ø¨:**
- ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ Ø¯ÙˆÙ† ØªØµÙÙŠØ± Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªØªØ¨Ø¹
- ÙŠØ¸Ù‡Ø± Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ Ù‚Ø³Ù… "In Progress" Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† "Cancelled"

**Ø§Ù„Ø­Ù„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ:**
```sql
UPDATE orders 
SET tracking_stage = NULL, updated_at = NOW()
WHERE status = 'cancelled' AND tracking_stage IS NOT NULL;
```

**Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©:** ğŸ”´ Ø¹Ø§Ù„ÙŠØ© Ø¬Ø¯Ø§Ù‹ (ÙŠØ¤Ø«Ø± Ø¹Ù„Ù‰ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¨Ø§Ø´Ø±Ø©)

---

### 2. ğŸ”´ Ø·Ù„Ø¨ ÙÙŠ Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¹Ù…Ù„ Ù„ÙƒÙ† Ù„Ø¯ÙŠÙ‡ Ø£ÙˆÙ‚Ø§Øª Ø§Ù†ØªØ¸Ø§Ø±
**Ø§Ù„Ù…Ø´ÙƒÙ„Ø©:**
```json
{
  "tracking_stage": "working",
  "waiting_started_at": "2025-11-13T08:00:00Z",  // âŒ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† null
  "waiting_ends_at": "2025-11-13T08:30:00Z"      // âŒ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† null
}
```

**Ø§Ù„Ø³Ø¨Ø¨:**
- Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø­ØªØ±Ù Ø¨Ø§Ù„Ø¹Ù…Ù„ Ù„ÙƒÙ† Ù„Ù… ÙŠØªÙ… ØªØµÙÙŠØ± Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
- ÙŠØ³Ø¨Ø¨ ØªØ¶Ø§Ø±Ø¨ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª

**Ø§Ù„Ø­Ù„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ:**
```sql
UPDATE orders 
SET waiting_started_at = NULL, 
    waiting_ends_at = NULL,
    updated_at = NOW()
WHERE tracking_stage = 'working' 
AND (waiting_started_at IS NOT NULL OR waiting_ends_at IS NOT NULL);
```

**Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©:** ğŸ”´ Ø¹Ø§Ù„ÙŠØ© Ø¬Ø¯Ø§Ù‹

---

### 3. ğŸŸ  Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¯ÙØ¹ Ù„ÙƒÙ† Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ÙƒØªÙ…Ù„
**Ø§Ù„Ù…Ø´ÙƒÙ„Ø©:**
```json
{
  "tracking_stage": "payment_received",
  "status": "in-progress"  // âŒ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 'completed'
}
```

**Ø§Ù„Ø³Ø¨Ø¨:**
- ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¯ÙØ¹ Ø¯ÙˆÙ† ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨
- Ø§Ù„Ø·Ù„Ø¨ ÙŠØ¨Ø¯Ùˆ ØºÙŠØ± Ù…ÙƒØªÙ…Ù„ Ø±ØºÙ… Ø£Ù†Ù‡ Ø§Ù†ØªÙ‡Ù‰

**Ø§Ù„Ø­Ù„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ:**
```sql
UPDATE orders 
SET status = 'completed', updated_at = NOW()
WHERE tracking_stage = 'payment_received' 
AND status != 'completed';
```

**Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©:** ğŸŸ  Ù…ØªÙˆØ³Ø·Ø©

---

### 4. ğŸŸ  Ø·Ù„Ø¨ Ù…ÙƒØªÙ…Ù„ Ù„ÙƒÙ† Ø¨Ø¯ÙˆÙ† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹
**Ø§Ù„Ù…Ø´ÙƒÙ„Ø©:**
```json
{
  "status": "completed",
  "tracking_stage": "working"  // âŒ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 'payment_received'
}
```

**Ø§Ù„Ø³Ø¨Ø¨:**
- ØªÙ… Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ ÙŠØ¯ÙˆÙŠØ§Ù‹ Ø¯ÙˆÙ† Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù…Ø±Ø§Ø­Ù„ Ø§Ù„ØªØªØ¨Ø¹
- Ù‚Ø¯ ÙŠØ³Ø¨Ø¨ Ù…Ø´Ø§ÙƒÙ„ ÙÙŠ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠØ©

**Ø§Ù„Ø­Ù„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ:**
```sql
UPDATE orders 
SET tracking_stage = 'payment_received', updated_at = NOW()
WHERE status = 'completed' 
AND tracking_stage != 'payment_received';
```

**Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©:** ğŸŸ  Ù…ØªÙˆØ³Ø·Ø©

---

### 5. ğŸŸ  Ø·Ù„Ø¨ pending Ù„ÙƒÙ† Ù„Ù‡ tracking_stage
**Ø§Ù„Ù…Ø´ÙƒÙ„Ø©:**
```json
{
  "status": "pending",
  "tracking_stage": "moving"  // âŒ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† null
}
```

**Ø§Ù„Ø³Ø¨Ø¨:**
- Ø®Ø·Ø£ ÙÙŠ ØªØ³Ù„Ø³Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
- Ø·Ù„Ø¨ ØªÙ… Ø¥Ø±Ø¬Ø§Ø¹Ù‡ Ù„Ù€ pending Ø¯ÙˆÙ† ØªØµÙÙŠØ± Ø§Ù„ØªØªØ¨Ø¹

**Ø§Ù„Ø­Ù„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ:**
```sql
UPDATE orders 
SET tracking_stage = NULL, updated_at = NOW()
WHERE status = 'pending' 
AND tracking_stage IS NOT NULL;
```

**Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©:** ğŸŸ  Ù…ØªÙˆØ³Ø·Ø©

---

### 6. ğŸŸ¡ Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø¯ÙˆÙ† Ø£ÙˆÙ‚Ø§Øª ØµØ­ÙŠØ­Ø©
**Ø§Ù„Ù…Ø´ÙƒÙ„Ø©:**
```json
{
  "tracking_stage": "waiting",
  "waiting_started_at": null,   // âŒ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† timestamp
  "waiting_ends_at": null        // âŒ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† timestamp
}
```

**Ø§Ù„Ø³Ø¨Ø¨:**
- ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø¥Ù„Ù‰ waiting Ø¯ÙˆÙ† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ‚Ø§Øª
- Ù„Ø§ ÙŠÙ…ÙƒÙ† Ù…Ø¹Ø±ÙØ© Ù…ØªÙ‰ Ø¨Ø¯Ø£ Ø£Ùˆ Ù…ØªÙ‰ ÙŠÙ†ØªÙ‡ÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±

**Ø§Ù„Ø­Ù„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ:**
```sql
UPDATE orders 
SET tracking_stage = 'arrived',
    waiting_started_at = NULL,
    waiting_ends_at = NULL,
    updated_at = NOW()
WHERE tracking_stage = 'waiting' 
AND (waiting_started_at IS NULL OR waiting_ends_at IS NULL);
```

**Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©:** ğŸŸ¡ Ù…Ù†Ø®ÙØ¶Ø© (Ø­Ø§Ù„Ø§Øª Ù†Ø§Ø¯Ø±Ø©)

---

### 7. ğŸ”´ Ø·Ù„Ø¨ Ø¹Ø§Ù„Ù‚ ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± (ØªØ¬Ø§ÙˆØ² Ø§Ù„ÙˆÙ‚Øª)
**Ø§Ù„Ù…Ø´ÙƒÙ„Ø©:**
```json
{
  "tracking_stage": "waiting",
  "waiting_ends_at": "2025-11-13T08:00:00Z",  // Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª Ù…Ù†Ø° Ø³Ø§Ø¹Ø§Øª
  "current_time": "2025-11-13T12:00:00Z"
}
```

**Ø§Ù„Ø³Ø¨Ø¨:**
- Ø§Ù†ØªÙ‡Ù‰ ÙˆÙ‚Øª Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙˆÙ„Ù… ÙŠØ­Ø¶Ø±
- Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹

**Ø§Ù„Ø­Ù„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ:**
```sql
UPDATE orders 
SET status = 'pending',
    tracking_stage = NULL,
    waiting_started_at = NULL,
    waiting_ends_at = NULL,
    updated_at = NOW()
WHERE tracking_stage = 'waiting' 
AND waiting_ends_at < NOW();
```

**Ù…Ù„Ø§Ø­Ø¸Ø©:** ÙŠÙ…ÙƒÙ† Ø£ÙŠØ¶Ø§Ù‹ Ù†Ù‚Ù„Ù‡ Ø¥Ù„Ù‰ `cancelled` Ø­Ø³Ø¨ Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø´Ø±ÙƒØ©

**Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©:** ğŸ”´ Ø¹Ø§Ù„ÙŠØ©

---

### 8. ğŸŸ¡ tracking Ø¨Ø¯ÙˆÙ† Ù…Ø­ØªØ±Ù Ù…Ù‚Ø¨ÙˆÙ„
**Ø§Ù„Ù…Ø´ÙƒÙ„Ø©:**
```json
{
  "tracking_stage": "working",
  "order_specialists": [
    { "is_accepted": false },
    { "is_accepted": null }
  ]
  // Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­ØªØ±Ù Ù…Ø¹ is_accepted = true
}
```

**Ø§Ù„Ø³Ø¨Ø¨:**
- ØªÙ… Ø¨Ø¯Ø¡ Ø§Ù„ØªØªØ¨Ø¹ Ø¯ÙˆÙ† ÙˆØ¬ÙˆØ¯ Ù…Ø­ØªØ±Ù Ù…Ù‚Ø¨ÙˆÙ„
- Ø£Ùˆ ØªÙ… Ø±ÙØ¶/Ø­Ø°Ù Ø§Ù„Ù…Ø­ØªØ±Ù Ø¨Ø¹Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØªØ¨Ø¹

**Ø§Ù„Ø­Ù„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ:**
```sql
-- ÙŠØªØ·Ù„Ø¨ query Ù…Ø¹Ù‚Ø¯ Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† order_specialists
UPDATE orders o
SET tracking_stage = NULL,
    status = 'pending',
    updated_at = NOW()
WHERE o.tracking_stage IN ('moving', 'arrived', 'working')
AND NOT EXISTS (
  SELECT 1 FROM order_specialists os
  WHERE os.order_id = o.id AND os.is_accepted = true
);
```

**Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©:** ğŸŸ¡ Ù…Ù†Ø®ÙØ¶Ø© (Ù†Ø§Ø¯Ø±Ø© Ø¬Ø¯Ø§Ù‹)

---

## ğŸ”§ Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ

### ØªØ´ØºÙŠÙ„ Cron Job ÙƒÙ„ 5 Ø¯Ù‚Ø§Ø¦Ù‚
```sql
SELECT cron.schedule(
  'fix-inconsistent-orders',
  '*/5 * * * *',
  $$
  SELECT net.http_post(
    url := 'https://your-project.supabase.co/functions/v1/fix-inconsistent-orders',
    headers := jsonb_build_object(
      'Content-Type', 'application/json',
      'Authorization', 'Bearer YOUR_ANON_KEY'
    )
  );
  $$
);
```

### Edge Function: fix-inconsistent-orders
ÙŠÙ‚ÙˆÙ… Ø¨Ù€:
1. ÙØ­Øµ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…ØªÙ†Ø§Ù‚Ø¶Ø©
2. Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù„ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹
3. ØªØ³Ø¬ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥ØµÙ„Ø§Ø­Ø§Øª ÙÙŠ logs
4. Ø¥Ø±Ø³Ø§Ù„ ØªÙ‚Ø±ÙŠØ± Ø¨Ø§Ù„Ù†ØªØ§Ø¦Ø¬

### Ø§Ù„ÙˆØµÙˆÙ„ Ù„ØµÙØ­Ø© Ø§Ù„ØªØ´Ø®ÙŠØµ
```
/orders-diagnostics
```

**Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª:**
- Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ù…ÙƒØªØ´ÙØ©
- ØªØµÙ†ÙŠÙ Ø­Ø³Ø¨ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©
- Ø²Ø± "Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ÙƒÙ„" Ø¨Ø¶ØºØ·Ø© ÙˆØ§Ø­Ø¯Ø©
- Ø³Ø¬Ù„ ÙƒØ§Ù…Ù„ Ù„Ù„Ø¥ØµÙ„Ø§Ø­Ø§Øª

---

## ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø­Ø§Ù„Ø§Øª

### Ø§Ù„ÙÙ„ØªØ±Ø© ÙÙŠ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©

**New Requests (pending)**
```javascript
status === 'pending' && !tracking_stage
```

**Awaiting Response (in-progress)**
```javascript
status === 'in-progress' && !tracking_stage
```

**Upcoming/Confirmed**
```javascript
(status === 'upcoming' || has_accepted_quote) && !tracking_stage
```

**In Progress**
```javascript
tracking_stage IN ('moving', 'arrived', 'working', 'invoice_requested')
&& status !== 'cancelled'  // â­ Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹!
```

**Completed**
```javascript
tracking_stage === 'payment_received' || status === 'completed'
```

**Cancelled**
```javascript
status === 'cancelled'
&& tracking_stage === null  // ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† null Ø¯Ø§Ø¦Ù…Ø§Ù‹
```

---

## ğŸ›¡ï¸ Ø§Ù„ÙˆÙ‚Ø§ÙŠØ© Ù…Ù† Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…ØªÙ†Ø§Ù‚Ø¶Ø©

### 1. Ø§Ø³ØªØ®Ø¯Ø§Ù… Database Triggers
```sql
-- Trigger Ù„ØªØµÙÙŠØ± tracking_stage Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ù„ØºØ§Ø¡
CREATE OR REPLACE FUNCTION clear_tracking_on_cancel()
RETURNS TRIGGER AS $$
BEGIN
  IF NEW.status = 'cancelled' THEN
    NEW.tracking_stage := NULL;
    NEW.waiting_started_at := NULL;
    NEW.waiting_ends_at := NULL;
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_clear_tracking_on_cancel
  BEFORE UPDATE ON orders
  FOR EACH ROW
  EXECUTE FUNCTION clear_tracking_on_cancel();
```

### 2. Ø§Ø³ØªØ®Ø¯Ø§Ù… Database Constraints
```sql
-- Ù…Ù†Ø¹ tracking_stage Ù…Ø¹ status = cancelled
ALTER TABLE orders ADD CONSTRAINT check_no_tracking_when_cancelled
  CHECK (
    (status = 'cancelled' AND tracking_stage IS NULL) OR
    status != 'cancelled'
  );

-- Ù…Ù†Ø¹ waiting times Ù…Ø¹ tracking_stage = working
ALTER TABLE orders ADD CONSTRAINT check_no_waiting_when_working
  CHECK (
    (tracking_stage = 'working' AND waiting_started_at IS NULL AND waiting_ends_at IS NULL) OR
    tracking_stage != 'working'
  );
```

### 3. Ø§Ù„ØªØ­Ù‚Ù‚ ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ (Application Level)
```typescript
// Ù‚Ø¨Ù„ ØªØ­Ø¯ÙŠØ« status Ø¥Ù„Ù‰ cancelled
await supabase
  .from('orders')
  .update({
    status: 'cancelled',
    tracking_stage: null,  // â­ Ø¯Ø§Ø¦Ù…Ø§Ù‹ ØµÙÙ‘Ø± tracking_stage
    waiting_started_at: null,
    waiting_ends_at: null,
    cancelled_at: new Date().toISOString(),
    cancelled_by: userId
  })
  .eq('id', orderId);
```

---

## ğŸ“ˆ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø¬ÙˆØ¯Ø©

### Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ (KPIs)
1. **Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…ØªÙ†Ø§Ù‚Ø¶Ø© Ø§Ù„Ù…ÙƒØªØ´ÙØ© ÙŠÙˆÙ…ÙŠØ§Ù‹**
   - Ø§Ù„Ù‡Ø¯Ù: < 5 Ø­Ø§Ù„Ø§Øª/ÙŠÙˆÙ…

2. **ÙˆÙ‚Øª Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ**
   - Ø§Ù„Ù‡Ø¯Ù: < 5 Ø¯Ù‚Ø§Ø¦Ù‚

3. **Ù…Ø¹Ø¯Ù„ ØªÙƒØ±Ø§Ø± Ù†ÙØ³ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©**
   - Ø§Ù„Ù‡Ø¯Ù: 0% (Ù„Ø§ ØªØªÙƒØ±Ø± Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ØµÙ„Ø§Ø­)

### Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª (Alerts)
```typescript
// Ø¥Ø±Ø³Ø§Ù„ ØªÙ†Ø¨ÙŠÙ‡ Ø¥Ø°Ø§ ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ø£ÙƒØ«Ø± Ù…Ù† 10 Ø­Ø§Ù„Ø§Øª Ù…ØªÙ†Ø§Ù‚Ø¶Ø©
if (totalInconsistencies > 10) {
  await sendAdminAlert({
    type: 'critical',
    message: `Found ${totalInconsistencies} inconsistent orders`,
    action: 'Review logs and check for system issues'
  });
}
```

---

## ğŸ¯ Ø§Ù„Ø®Ù„Ø§ØµØ©

### Ù‚ÙˆØ§Ø¹Ø¯ Ø°Ù‡Ø¨ÙŠØ©:
1. âœ… **cancelled** = `tracking_stage: null` (Ø¯Ø§Ø¦Ù…Ø§Ù‹!)
2. âœ… **working** = `waiting_started_at: null, waiting_ends_at: null`
3. âœ… **completed** = `tracking_stage: 'payment_received'`
4. âœ… **payment_received** = `status: 'completed'`
5. âœ… **pending** = `tracking_stage: null`
6. âœ… **waiting** = `waiting_started_at & waiting_ends_at` (ÙƒÙ„Ø§Ù‡Ù…Ø§ Ù…ÙˆØ¬ÙˆØ¯)

### Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥ØµÙ„Ø§Ø­:
- ğŸ”„ ÙØ­Øµ ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒÙ„ 5 Ø¯Ù‚Ø§Ø¦Ù‚
- ğŸ¯ Ø£ÙˆÙ„ÙˆÙŠØ§Øª ÙˆØ§Ø¶Ø­Ø© Ù„Ù„Ø¥ØµÙ„Ø§Ø­
- ğŸ“Š ØµÙØ­Ø© ØªØ´Ø®ÙŠØµ Ø´Ø§Ù…Ù„Ø©
- ğŸ›¡ï¸ ÙˆÙ‚Ø§ÙŠØ© Ù…Ù† Ø§Ù„ØªÙƒØ±Ø§Ø± Ø¹Ø¨Ø± triggers

---

**Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«:** 2025-11-13
**Ø§Ù„Ù†Ø³Ø®Ø©:** 1.0
